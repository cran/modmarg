<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="date" content="2017-10-29" />

<title>Modmarg Usage</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Modmarg Usage</h1>
<h4 class="date"><em>2017-10-29</em></h4>



<div id="why-margins" class="section level1">
<h1>Why Margins?</h1>
<p>For many types of regression techniques, the coefficients in the model may not be sufficient to adequately figure out the marginal relationship between a covariate and the outcome of a regression (or the error in your estimate). In the simplest case, say you run the following formula in glm: <code>wages ~ age + age^2</code>.</p>
<p>Because the output will include coefficients for both age and age squared, it’s not immediately apparent what the total marginal relationship is between a change in age and wages. Moreover, computing the error in that estimate is a non-trivial problem.</p>
<p>This non-obviousness of marginal relationships is also a problem for even very simple regressions with functional forms that mean that coefficients are not in the base units of the regression. For example, the coefficients of logistic regression are odds ratios, so even simple regressions are not immediately interpretable.</p>
<p>This package reproduces the <code>margins</code> command from Stata, which allows for easy and quick estimation of marginal relationships and the associated error. The error is computed using the delta method, which we detail in a separate <a href="delta-method.html">vignette</a>.</p>
<p>In this vignette, we detail a few possible use cases of the <code>modmarg</code> package.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
</div>
<div id="use-case-1-treatment-effects-and-subgroup-effects" class="section level1">
<h1>Use Case 1: Treatment Effects and Subgroup Effects</h1>
<p>We want to ascertain the marginal effect of <code>treatment</code> on <code>y</code> while controlling for age. In this first example we’ll use a binned age variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(modmarg)
<span class="kw">data</span>(margex)

g &lt;-<span class="st"> </span><span class="kw">glm</span>(y ~<span class="st"> </span><span class="kw">as.factor</span>(agegroup)*<span class="kw">as.factor</span>(treatment) , <span class="dt">data =</span> margex)
<span class="kw">summary</span>(g)</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ as.factor(agegroup) * as.factor(treatment), 
##     data = margex)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -68.490  -13.922    0.178   14.042   71.678  
## 
## Coefficients:
##                                                Estimate Std. Error t value
## (Intercept)                                     68.6901     0.8921  77.001
## as.factor(agegroup)30-39                        -1.4677     1.3448  -1.091
## as.factor(agegroup)40+                          -9.8679     1.2384  -7.968
## as.factor(treatment)1                           14.6799     1.6316   8.997
## as.factor(agegroup)30-39:as.factor(treatment)1  -2.1209     2.2438  -0.945
## as.factor(agegroup)40+:as.factor(treatment)1    -2.1073     1.9565  -1.077
##                                                Pr(&gt;|t|)    
## (Intercept)                                     &lt; 2e-16 ***
## as.factor(agegroup)30-39                          0.275    
## as.factor(agegroup)40+                         2.27e-15 ***
## as.factor(treatment)1                           &lt; 2e-16 ***
## as.factor(agegroup)30-39:as.factor(treatment)1    0.345    
## as.factor(agegroup)40+:as.factor(treatment)1      0.282    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for gaussian family taken to be 416.1914)
## 
##     Null deviance: 1391433  on 2999  degrees of freedom
## Residual deviance: 1246077  on 2994  degrees of freedom
## AIC: 26615
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<p>It’s not at all obvious from these coefficients what the total marginal relationship is between <code>treatment</code> and <code>y</code>.</p>
<p>We can get the predicted margin of <code>y</code> at the various levels of <code>treatment</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modmarg::<span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;treatment&quot;</span>, <span class="dt">type =</span> <span class="st">'levels'</span>)</code></pre></div>
<pre><code>## [[1]]
##           Label   Margin Standard.Error Test.Stat P.Value Lower CI (95%)
## 1 treatment = 0 63.28363      0.5484021  115.3964       0       62.20835
## 2 treatment = 1 76.37699      0.5526036  138.2130       0       75.29347
##   Upper CI (95%)
## 1       64.35892
## 2       77.46051</code></pre>
<p>Or the effect of a unit change in <code>treatment</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modmarg::<span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;treatment&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;effects&quot;</span>)</code></pre></div>
<pre><code>## [[1]]
##           Label   Margin Standard.Error Test.Stat      P.Value
## 1 treatment = 0  0.00000      0.0000000       NaN          NaN
## 2 treatment = 1 13.09336      0.7785343  16.81796 1.013688e-60
##   Lower CI (95%) Upper CI (95%)
## 1        0.00000        0.00000
## 2       11.56684       14.61988</code></pre>
<p>Or maybe we want to get treatment effect at several different levels of age. Let’s re-run the regression with continuous age cubed (maybe we’re looking at severity of a disease that’s most prevalent among the young and the old).</p>
<p>Note that you have to use <code>raw = T</code> when using <code>poly()</code>. Otherwise <code>marg</code> will try to create multiple orthogonal vectors from a constant, which doesn’t work so well.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span><span class="kw">glm</span>(y ~<span class="st"> </span><span class="kw">poly</span>(age, <span class="dv">3</span>, <span class="dt">raw =</span> T) *<span class="st"> </span><span class="kw">as.factor</span>(treatment) , <span class="dt">data =</span> margex)
<span class="kw">summary</span>(g)</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ poly(age, 3, raw = T) * as.factor(treatment), 
##     data = margex)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -70.52  -13.86   -0.37   13.91   73.13  
## 
## Coefficients:
##                                                Estimate Std. Error t value
## (Intercept)                                   1.118e+02  2.371e+01   4.716
## poly(age, 3, raw = T)1                       -3.741e+00  2.012e+00  -1.860
## poly(age, 3, raw = T)2                        1.077e-01  5.415e-02   1.990
## poly(age, 3, raw = T)3                       -1.083e-03  4.649e-04  -2.329
## as.factor(treatment)1                        -4.282e+01  3.677e+01  -1.165
## poly(age, 3, raw = T)1:as.factor(treatment)1  4.973e+00  2.997e+00   1.659
## poly(age, 3, raw = T)2:as.factor(treatment)1 -1.392e-01  7.788e-02  -1.788
## poly(age, 3, raw = T)3:as.factor(treatment)1  1.244e-03  6.486e-04   1.918
##                                              Pr(&gt;|t|)    
## (Intercept)                                  2.52e-06 ***
## poly(age, 3, raw = T)1                         0.0630 .  
## poly(age, 3, raw = T)2                         0.0467 *  
## poly(age, 3, raw = T)3                         0.0199 *  
## as.factor(treatment)1                          0.2442    
## poly(age, 3, raw = T)1:as.factor(treatment)1   0.0972 .  
## poly(age, 3, raw = T)2:as.factor(treatment)1   0.0739 .  
## poly(age, 3, raw = T)3:as.factor(treatment)1   0.0552 .  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for gaussian family taken to be 404.2444)
## 
##     Null deviance: 1391433  on 2999  degrees of freedom
## Residual deviance: 1209499  on 2992  degrees of freedom
## AIC: 26530
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modmarg::<span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;treatment&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;effects&quot;</span>,
              <span class="dt">at =</span> <span class="kw">list</span>(<span class="st">&quot;age&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">20</span>, <span class="dv">40</span>, <span class="dv">60</span>)))</code></pre></div>
<pre><code>## $`age = 20`
##           Label   Margin Standard.Error Test.Stat      P.Value
## 1 treatment = 0  0.00000       0.000000       NaN          NaN
## 2 treatment = 1 10.90186       3.278277  3.325484 0.0008932985
##   Lower CI (95%) Upper CI (95%)
## 1       0.000000        0.00000
## 2       4.473953       17.32976
## 
## $`age = 40`
##           Label   Margin Standard.Error Test.Stat      P.Value
## 1 treatment = 0  0.00000       0.000000       NaN          NaN
## 2 treatment = 1 12.96123       1.128904  11.48125 6.862963e-30
##   Lower CI (95%) Upper CI (95%)
## 1        0.00000        0.00000
## 2       10.74772       15.17474
## 
## $`age = 60`
##           Label   Margin Standard.Error Test.Stat      P.Value
## 1 treatment = 0  0.00000       0.000000       NaN          NaN
## 2 treatment = 1 23.06926       3.492633  6.605119 4.683001e-11
##   Lower CI (95%) Upper CI (95%)
## 1        0.00000        0.00000
## 2       16.22105       29.91746</code></pre>
</div>
<div id="use-case-2-logistic-regression" class="section level1">
<h1>Use Case 2: Logistic Regression</h1>
<p>Let’s say we want to figure out how much <code>treatment</code> increased the likelihood of a binary <code>outcome</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span><span class="kw">glm</span>(outcome ~<span class="st"> </span><span class="kw">as.factor</span>(treatment), <span class="dt">data =</span> margex, <span class="dt">family =</span> binomial)
<span class="kw">summary</span>(g)</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = outcome ~ as.factor(treatment), family = binomial, 
##     data = margex)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -0.7754  -0.7754  -0.4069  -0.4069   2.2507  
## 
## Coefficients:
##                       Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)           -2.44999    0.09554  -25.64   &lt;2e-16 ***
## as.factor(treatment)1  1.40222    0.11221   12.50   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 2732.1  on 2999  degrees of freedom
## Residual deviance: 2551.5  on 2998  degrees of freedom
## AIC: 2555.5
## 
## Number of Fisher Scoring iterations: 5</code></pre>
<p>Those coefficients are odds ratios. It’s really unclear what the marginal relationship is.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;treatment&quot;</span>, <span class="dt">type =</span> <span class="st">'levels'</span>)</code></pre></div>
<pre><code>## [[1]]
##           Label     Margin Standard.Error Test.Stat       P.Value
## 1 treatment = 0 0.07943925    0.006986952  11.36966  5.921906e-30
## 2 treatment = 1 0.25965379    0.011313052  22.95170 1.416955e-116
##   Lower CI (95%) Upper CI (95%)
## 1     0.06574508     0.09313343
## 2     0.23748062     0.28182697</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;treatment&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;effects&quot;</span>)</code></pre></div>
<pre><code>## [[1]]
##           Label    Margin Standard.Error Test.Stat      P.Value
## 1 treatment = 0 0.0000000     0.00000000       NaN          NaN
## 2 treatment = 1 0.1802145     0.01329672  13.55331 7.573387e-42
##   Lower CI (95%) Upper CI (95%)
## 1      0.0000000      0.0000000
## 2      0.1541535      0.2062756</code></pre>
<p>Aha! It’s an 18 percentage point increase in the likelihood of a positive outcome from treatment and the effect is highly statistically significant. Much more interpretable.</p>
</div>
<div id="use-case-3-getting-margins-at-specific-values-of-variable-of-interest" class="section level1">
<h1>Use Case 3: Getting Margins At Specific Values of Variable of Interest</h1>
<p>Let’s say we want to know the marginal predicted level at only a couple of age groups while controlling for distance. <code>marg</code> makes that simple.</p>
<p>Note that unlike the <code>at</code> option, which takes a named list of values, <code>at_var_interest</code> takes just an unnamed vector.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span><span class="kw">glm</span>(y ~<span class="st"> </span><span class="kw">poly</span>(distance, <span class="dv">2</span>, <span class="dt">raw =</span> T) *<span class="st"> </span><span class="kw">as.factor</span>(agegroup) , <span class="dt">data =</span> margex)
<span class="kw">summary</span>(g)</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ poly(distance, 2, raw = T) * as.factor(agegroup), 
##     data = margex)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -72.507  -14.911    0.076   14.434   73.228  
## 
## Coefficients:
##                                                        Estimate Std. Error
## (Intercept)                                           7.269e+01  9.098e-01
## poly(distance, 2, raw = T)1                           8.555e-02  1.112e-01
## poly(distance, 2, raw = T)2                          -1.175e-04  1.552e-04
## as.factor(agegroup)30-39                             -4.524e-01  1.386e+00
## as.factor(agegroup)40+                               -6.516e+00  1.239e+00
## poly(distance, 2, raw = T)1:as.factor(agegroup)30-39  6.289e-02  1.520e-01
## poly(distance, 2, raw = T)2:as.factor(agegroup)30-39 -1.053e-04  2.124e-04
## poly(distance, 2, raw = T)1:as.factor(agegroup)40+    1.008e-02  1.243e-01
## poly(distance, 2, raw = T)2:as.factor(agegroup)40+   -2.796e-05  1.732e-04
##                                                      t value Pr(&gt;|t|)    
## (Intercept)                                           79.888  &lt; 2e-16 ***
## poly(distance, 2, raw = T)1                            0.770    0.442    
## poly(distance, 2, raw = T)2                           -0.757    0.449    
## as.factor(agegroup)30-39                              -0.326    0.744    
## as.factor(agegroup)40+                                -5.260 1.54e-07 ***
## poly(distance, 2, raw = T)1:as.factor(agegroup)30-39   0.414    0.679    
## poly(distance, 2, raw = T)2:as.factor(agegroup)30-39  -0.496    0.620    
## poly(distance, 2, raw = T)1:as.factor(agegroup)40+     0.081    0.935    
## poly(distance, 2, raw = T)2:as.factor(agegroup)40+    -0.161    0.872    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for gaussian family taken to be 452.6186)
## 
##     Null deviance: 1391433  on 2999  degrees of freedom
## Residual deviance: 1353782  on 2991  degrees of freedom
## AIC: 26870
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">unique</span>(margex$agegroup)</code></pre></div>
<pre><code>## [1] &quot;40+&quot;   &quot;20-29&quot; &quot;30-39&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;agegroup&quot;</span>, <span class="dt">type =</span> <span class="st">'levels'</span>,
          <span class="dt">at_var_interest =</span> <span class="kw">c</span>(<span class="st">&quot;20-29&quot;</span>))</code></pre></div>
<pre><code>## [[1]]
##              Label   Margin Standard.Error Test.Stat P.Value
## 1 agegroup = 20-29 73.42933      0.9075403  80.91028       0
##   Lower CI (95%) Upper CI (95%)
## 1       71.64987        75.2088</code></pre>
</div>
<div id="use-case-4-getting-margins-with-different-variance-covariance-matrices" class="section level1">
<h1>Use Case 4: Getting Margins with Different Variance-Covariance Matrices</h1>
<p>Normally we assume that the amount of variation in our outcome of interest (conditional on covariates) is constant across our sample. Sometimes, this assumption is violated, and we will use a different variance-covariance matrix to represent this heterogeneity in variance (heteroskedasticity). Creating these variance-covariance matrices is beyond the scope of this package. However, they can be used with <code>marg</code> to correct standard errors and p values in predicted levels or effects.</p>
<p>Let’s say we want to get the predicted levels of an outcome for different treatments, but we want to cluster our standard errors by the <code>arm</code> variable. We estimate the model, and then create the “clustered” variance-covariance matrix separately (see <a href="https://github.com/anniejw6/modmarg/blob/master/data-raw/make_cluster_vcov.R">this script</a> for one method to do this). This code and example replicate the <code>vce(cluster arm)</code> option in Stata.</p>
<p>We can use the <code>vcov_mat</code> option to pass a custom variance-covariance matrix to modmarg. Because this is an OLS model, the degrees of freedom for the T test must also be corrected. Here we’re using Stata’s default correction of <code>ngroups - 1</code>, where <code>ngroups</code> is the number of unique values in the clustering variable. Notice the standard errors and p values increase substantially.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(cvcov)
g &lt;-<span class="st"> </span><span class="kw">glm</span>(outcome ~<span class="st"> </span>treatment +<span class="st"> </span>distance, <span class="dt">data =</span> margex, <span class="dt">family =</span> <span class="st">'gaussian'</span>)
<span class="kw">summary</span>(g)</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = outcome ~ treatment + distance, family = &quot;gaussian&quot;, 
##     data = margex)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -0.27237  -0.26920  -0.09337  -0.09123   0.91224  
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  9.378e-02  9.625e-03   9.743  &lt; 2e-16 ***
## treatment    1.786e-01  1.323e-02  13.508  &lt; 2e-16 ***
## distance    -2.314e-04  3.646e-05  -6.346 2.55e-10 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for gaussian family taken to be 0.1311316)
## 
##     Null deviance: 422.64  on 2999  degrees of freedom
## Residual deviance: 393.00  on 2997  degrees of freedom
## AIC: 2424
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">v &lt;-<span class="st"> </span>cvcov$ols$clust
<span class="kw">print</span>(v)</code></pre></div>
<pre><code>##               (Intercept)    treatment1      distance
## (Intercept)  2.970431e-03 -4.945889e-04 -5.960823e-06
## treatment1  -4.945889e-04  7.952403e-04  5.335865e-07
## distance    -5.960823e-06  5.335865e-07  1.225712e-08</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span>cvcov$ols$stata_dof
<span class="kw">print</span>(d)</code></pre></div>
<pre><code>## [1] 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Without clustering</span>
<span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;treatment&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;levels&quot;</span>)</code></pre></div>
<pre><code>## [[1]]
##           Label    Margin Standard.Error Test.Stat       P.Value
## 1 treatment = 0 0.0802249    0.009356981  8.573802  1.579014e-17
## 2 treatment = 1 0.2588702    0.009344512 27.702918 1.362609e-150
##   Lower CI (95%) Upper CI (95%)
## 1     0.06187815     0.09857166
## 2     0.24054793     0.27719254</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># With clustering</span>
<span class="kw">marg</span>(<span class="dt">mod =</span> g, <span class="dt">var_interest =</span> <span class="st">&quot;treatment&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;levels&quot;</span>,
          <span class="dt">vcov_mat =</span> v, <span class="dt">dof =</span> d)</code></pre></div>
<pre><code>## [[1]]
##           Label    Margin Standard.Error Test.Stat    P.Value
## 1 treatment = 0 0.0802249     0.04810472  1.667714 0.23730671
## 2 treatment = 1 0.2588702     0.04671881  5.541028 0.03106062
##   Lower CI (95%) Upper CI (95%)
## 1    -0.12675299      0.2872028
## 2     0.05785542      0.4598851</code></pre>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Modmarg is short for <em>model margins</em>.<a href="#fnref1">↩</a></p></li>
</ol>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
